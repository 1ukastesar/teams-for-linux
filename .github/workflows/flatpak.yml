name: Flatpak Build

on: push

defaults:
  run:
    shell: bash

jobs:

  flatpak:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8']

    steps:
      - name: Install flatpak & flatpak-builder
        run: sudo apt-get install flatpak flatpak-builder -y

      - name: Add flathub repo
        run: sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Install flatpak dependencies
        run: sudo flatpak install flathub org.freedesktop.Sdk/x86_64/21.08 -y |
          sudo flatpak install flathub org.electronjs.Electron2.BaseApp//21.08 -y |
          sudo flatpak install flathub org.freedesktop.Sdk.Extension.node14//21.08 -y

      - name: Check out Git repository
        uses: actions/checkout@v2
      
      - name: Install Node.js, NPM, Yarn and generate package-lock.json
        uses: actions/setup-node@v1
        with:
          node-version: 14
      - run: npm install --package-lock-only

      - name: Install python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
          architecture: 'x64'

      - name: Install pip3 and packages
        uses: BSFishy/pip-action@v1
        with:
          packages: | 
            aiohttp
      - run: python3 flatpak-node-generator.py npm --xdg-layout package-lock.json 

      - name: Prepare package.json for flatpak-builder
        uses: sergeysova/jq-action@v2
        with:
          cmd: jq '.build.linux.target="dir"' <<<$(<package.json) > package.json
      
      - name: Start flatpak build
        run: sudo flatpak-builder flatpak-build com.github.ismaelmartinez.teams-for-linux.yml --install --force-clean --user