name: Upload to APT repo

on:
  workflow_call:
    inputs:
      artifact-name:
        description: 'The name of the artifact to download'
        required: true
        type: string
      apt-repo-pool-path:
        description: 'APT repo pool path'
        required: true
        type: string
      apt-repo-update-script:
        description: 'APT repo update script'
        required: true
        type: string
    secrets:
      APT_REPO_HOST:
        required: true
      APT_REPO_USER:
        required: true
      APT_REPO_KEY:
        required: true
      APT_REPO_PORT:
        required: true
      APT_REPO_PATH:
        required: true

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: dist

      - name: Upload artifact to custom apt repo
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.APT_REPO_HOST }}
          username: ${{ secrets.APT_REPO_USER }}
          key: ${{ secrets.APT_REPO_KEY }}
          port: ${{ secrets.APT_REPO_PORT }}
          source: "dist/*.deb"
          target: ${{ secrets.APT_REPO_PATH }}/${{ inputs.apt-repo-pool-path }}

      - name: Update repo after upload
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.APT_REPO_HOST }}
          username: ${{ secrets.APT_REPO_USER }}
          key: ${{ secrets.APT_REPO_KEY }}
          port: ${{ secrets.APT_REPO_PORT }}
          script: ${{ secrets.APT_REPO_PATH }}/${{ inputs.apt-repo-update-script }}
